{
    "logging": {
        "logs": {
            "default": {
                "writer": {
                    "output": "stderr"
                },
                "encoder": {
                    "format": "console"
                },
                "level": "DEBUG"
            }
        }
    },
    "apps": {
        "docker": {
            "containers": {
                "demo-nginx": {
                    "restart": {
                        "policy": "always"
                    },
                    "security": null,
                    "mounts": [
                        {
                            "Type": "bind",
                            "source": "/data/test",
                            "target": "/data"
                        }
                    ],
                    "image": "docker.io/library/nginx:latest",
                    "env": {
                        "ENV1": "value1",
                        "ENV2": "value2",
                        "ENV3": "value3"
                    },
                    "labels": {
                        "com.quara-dev.service": "test",
                        "com.quara-dev.service.env": "dev",
                        "com.quara-dev.service.version": "1.0.0"
                    },
                    "networks": [
                        {
                            "id": "mynetwork"
                        }
                    ]
                },
                "other": {
                    "restart": {
                        "policy": "on-failure"
                    },
                    "security": null,
                    "image": "docker.io/library/alpine:latest"
                }
            },
            "networks": {
                "mynetwork": {
                    "driver": "bridge",
                    "ipam": {
                        "driver": "default",
                        "config": [
                            {
                                "subnet": "172.200.200.0/24",
                                "gateway": "172.200.200.1"
                            }
                        ]
                    }
                }
            }
        },
        "http": {
            "servers": {
                "srv0": {
                    "listen": [
                        ":443"
                    ],
                    "routes": [
                        {
                            "match": [
                                {
                                    "host": [
                                        "metrics.local.quara-dev.com"
                                    ]
                                }
                            ],
                            "handle": [
                                {
                                    "handler": "subroute",
                                    "routes": [
                                        {
                                            "handle": [
                                                {
                                                    "handler": "metrics"
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ],
                            "terminal": true
                        },
                        {
                            "match": [
                                {
                                    "host": [
                                        "admin.local.quara-dev.com"
                                    ]
                                }
                            ],
                            "handle": [
                                {
                                    "handler": "subroute",
                                    "routes": [
                                        {
                                            "handle": [
                                                {
                                                    "handler": "vars",
                                                    "root": "./www/index.html"
                                                },
                                                {
                                                    "endpoint": {
                                                        "name": "az-oidc-endpoint"
                                                    },
                                                    "handler": "oauth2_session"
                                                },
                                                {
                                                    "handler": "file_server",
                                                    "hide": [
                                                        "./Caddyfile"
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ],
                            "terminal": true
                        },
                        {
                            "match": [
                                {
                                    "host": [
                                        "demo.local.quara-dev.com"
                                    ]
                                }
                            ],
                            "handle": [
                                {
                                    "handler": "subroute",
                                    "routes": [
                                        {
                                            "handle": [
                                                {
                                                    "endpoint": {
                                                        "name": "az-oidc-endpoint"
                                                    },
                                                    "handler": "oauth2_session"
                                                },
                                                {
                                                    "dynamic_upstreams": {
                                                        "container": "demo-nginx",
                                                        "network": "mynetwork",
                                                        "port": 80,
                                                        "source": "docker"
                                                    },
                                                    "handler": "reverse_proxy"
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ],
                            "terminal": true
                        },
                        {
                            "match": [
                                {
                                    "host": [
                                        "local.quara-dev.com"
                                    ]
                                }
                            ],
                            "handle": [
                                {
                                    "handler": "subroute",
                                    "routes": [
                                        {
                                            "handle": [
                                                {
                                                    "endpoint": {
                                                        "name": "az-oidc-endpoint"
                                                    },
                                                    "handler": "oauth2_session"
                                                },
                                                {
                                                    "body": "hello world",
                                                    "handler": "static_response"
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ],
                            "terminal": true
                        }
                    ],
                    "logs": {
                        "logger_names": {
                            "admin.local.quara-dev.com": "",
                            "demo.local.quara-dev.com": "",
                            "local.quara-dev.com": "",
                            "metrics.local.quara-dev.com": ""
                        }
                    },
                    "metrics": {}
                }
            }
        },
        "nats_server": {
            "name": "srv-01",
            "tags": {
                "region": "eu-west-3"
            },
            "debug": true,
            "http_port": 8222,
            "automation_policy": {
                "issuers": [
                    {
                        "module": "internal"
                    }
                ]
            },
            "tls": {
                "subjects": [
                    "local.quara-dev.com",
                    "localhost"
                ]
            },
            "system_account": "SYS",
            "accounts": [
                {
                    "name": "OAUTH2",
                    "jetstream": true,
                    "authorization_policies": [
                        {
                            "callout": {
                                "module": "allow",
                                "template": {
                                    "pub": {},
                                    "sub": {}
                                }
                            },
                            "match": {
                                "host": [
                                    "127.0.0.1"
                                ],
                                "token": [
                                    "OAUTH2"
                                ]
                            }
                        }
                    ]
                },
                {
                    "name": "DATA",
                    "jetstream": true,
                    "authorization_policies": [
                        {
                            "callout": {
                                "module": "allow",
                                "template": {
                                    "pub": {},
                                    "sub": {}
                                }
                            },
                            "match": {
                                "host": [
                                    "127.0.0.1"
                                ],
                                "token": [
                                    "DATA"
                                ]
                            }
                        }
                    ],
                    "flows": [
                        {
                            "source": {
                                "collection": "test1",
                                "database": "test",
                                "type": "mongodb_change_stream",
                                "uri": "mongodb://localhost:27017"
                            },
                            "destination": {
                                "allow_direct": false,
                                "compression": "none",
                                "consumer_limits": {},
                                "discard": "old",
                                "max_age": 0,
                                "max_bytes": 0,
                                "max_consumers": 0,
                                "max_msgs": 0,
                                "max_msgs_per_subject": 0,
                                "mirror_direct": false,
                                "name": "MONGOSTREAM",
                                "num_replicas": 0,
                                "prefix": "mongo",
                                "retention": "limits",
                                "storage": "file",
                                "type": "stream"
                            }
                        },
                        {
                            "source": {
                                "ack_policy": "explicit",
                                "deliver_policy": "all",
                                "durable_name": "db-sync",
                                "num_replicas": 0,
                                "replay_policy": "instant",
                                "stream": "MONGOSTREAM",
                                "type": "stream_consumer"
                            },
                            "destination": {
                                "database": "test2",
                                "type": "mongodb_change_stream",
                                "uri": "mongodb://localhost:27017"
                            }
                        }
                    ],
                    "streams": [
                        {
                            "name": "test",
                            "subjects": [
                                "test.\u003e"
                            ],
                            "retention": "limits",
                            "max_consumers": 0,
                            "max_msgs": 0,
                            "max_bytes": 0,
                            "discard": "old",
                            "max_age": 0,
                            "max_msgs_per_subject": 0,
                            "storage": "file",
                            "num_replicas": 0,
                            "compression": "none",
                            "allow_direct": false,
                            "mirror_direct": false,
                            "consumer_limits": {},
                            "prefix": ""
                        }
                    ]
                },
                {
                    "name": "APP",
                    "jetstream": true,
                    "mappings": [
                        {
                            "subject": "canary.req.\u003e",
                            "dest": [
                                {
                                    "subject": "req.\u003e",
                                    "weight": 50
                                },
                                {
                                    "subject": "beta.req.\u003e",
                                    "weight": 50
                                }
                            ]
                        },
                        {
                            "subject": "pub.\u003e",
                            "dest": [
                                {
                                    "subject": "pub.srv-01.\u003e",
                                    "weight": 100
                                }
                            ]
                        }
                    ],
                    "authorization_policies": [
                        {
                            "callout": {
                                "module": "allow",
                                "template": {
                                    "pub": {},
                                    "sub": {}
                                }
                            },
                            "match": {
                                "host": [
                                    "127.0.0.1"
                                ],
                                "token": [
                                    "APP"
                                ],
                                "type": [
                                    "nats"
                                ]
                            }
                        },
                        {
                            "callout": {
                                "endpoint": "az-oidc-endpoint",
                                "module": "oauth2",
                                "template": {
                                    "pub": {
                                        "allow": [
                                            "\u003e"
                                        ]
                                    },
                                    "resp": {
                                        "max": 0,
                                        "ttl": 0
                                    },
                                    "sub": {
                                        "allow": [
                                            "_INBOX.{oidc.session.email}.\u003e",
                                            "{oidc.session.email}.\u003e"
                                        ]
                                    }
                                }
                            },
                            "match": {
                                "type": [
                                    "websocket"
                                ],
                                "username": [
                                    "APP"
                                ]
                            }
                        }
                    ]
                },
                {
                    "name": "SYS",
                    "exports": {
                        "services": [
                            {
                                "subject": "$SYS.REQ.SERVER.PING",
                                "to": [
                                    "MONITORING"
                                ]
                            }
                        ]
                    },
                    "authorization_policies": [
                        {
                            "callout": {
                                "module": "allow",
                                "template": {
                                    "pub": {},
                                    "sub": {}
                                }
                            },
                            "match": {
                                "host": [
                                    "127.0.0.1"
                                ],
                                "token": [
                                    "SYS"
                                ]
                            }
                        }
                    ]
                },
                {
                    "name": "MONITORING",
                    "imports": {
                        "services": [
                            {
                                "account": "SYS",
                                "subject": "$SYS.REQ.SERVER.PING"
                            }
                        ]
                    },
                    "authorization_policies": [
                        {
                            "callout": {
                                "module": "allow",
                                "template": {
                                    "pub": {},
                                    "sub": {}
                                }
                            },
                            "match": {
                                "host": [
                                    "127.0.0.1"
                                ],
                                "token": [
                                    "monitoring"
                                ]
                            }
                        }
                    ]
                }
            ],
            "auth_callout": {
                "account": "AUTH"
            },
            "websocket": {
                "advertise": "ws.local.quara-dev.com:10443",
                "tls": {
                    "subjects": [
                        "ws.local.quara-dev.com"
                    ]
                }
            },
            "mqtt": {
                "tls": {
                    "subjects": [
                        "mqtt.local.quara-dev.com"
                    ]
                }
            },
            "jetstream": {
                "unique_tag": "region",
                "store_dir": "./tmp/jetstream/t2",
                "max_memory": 1000000000,
                "max_file": 10000000000
            },
            "leafnode": {
                "advertise": "leafnode.local.quara-dev.com:7422",
                "tls": {
                    "subjects": [
                        "leafnode.local.quara-dev.com"
                    ]
                }
            },
            "metrics": {
                "healthz": true,
                "connz": true,
                "connz_detailed": true,
                "subz": true,
                "routez": true,
                "gatewayz": true,
                "leafz": true
            }
        },
        "oauth2": {
            "endpoints": [
                {
                    "name": "az-oidc-endpoint",
                    "options": {
                        "email_domains": [
                            "*"
                        ],
                        "whitelist_domains": [
                            ".local.quara-dev.com"
                        ],
                        "cookie": {
                            "name": "_oauth2_session",
                            "domains": [
                                ".local.quara-dev.com"
                            ],
                            "no_http_only": true
                        },
                        "templates": {
                            "show_debug_on_error": true
                        },
                        "providers": [
                            {
                                "clientID": "4a224c79-38e2-487f-96e0-5f4febfa4ce1",
                                "clientSecret": "{secret.oauth2-client-secret@az-kv-srv-01}",
                                "keycloakConfig": {},
                                "azureConfig": {},
                                "ADFSConfig": {},
                                "bitbucketConfig": {},
                                "githubConfig": {},
                                "gitlabConfig": {},
                                "googleConfig": {},
                                "oidcConfig": {
                                    "issuerURL": "https://login.microsoftonline.com/96bdcf75-3f33-4995-966b-d8eddb861f9b/v2.0",
                                    "jwksURL": "https://login.microsoftonline.com/common/discovery/keys",
                                    "emailClaim": "email",
                                    "userIDClaim": "email",
                                    "audienceClaims": [
                                        "aud"
                                    ]
                                },
                                "loginGovConfig": {},
                                "id": "azure-ad",
                                "provider": "oidc",
                                "name": "Azure AD",
                                "loginURL": "https://login.microsoftonline.com/96bdcf75-3f33-4995-966b-d8eddb861f9b/v2.0/oauth2/authorize",
                                "redeemURL": "https://login.microsoftonline.com/96bdcf75-3f33-4995-966b-d8eddb861f9b/v2.0/oauth2/token",
                                "profileURL": "https://graph.microsoft.com/v1.0/me",
                                "scope": "openid email profile"
                            }
                        ],
                        "extra_jwt_issuers": [
                            "https://sts.windows.net/96bdcf75-3f33-4995-966b-d8eddb861f9b/=4a224c79-38e2-487f-96e0-5f4febfa4ce1"
                        ]
                    },
                    "store": {
                        "name": "OAUTH2-SESSIONS",
                        "type": "jetstream"
                    }
                }
            ]
        },
        "secrets": {
            "stores": {
                "az-kv-srv-01": {
                    "module": "azure_keyvault",
                    "uri": "https://kv-srv-01.vault.azure.net"
                }
            },
            "automate": [
                {
                    "sources": [
                        "some-secret@az-kv-srv-01"
                    ],
                    "template": "The value is: {some-secret@az-kv-srv-01}",
                    "trigger": {
                        "interval": 3600000000000,
                        "type": "periodic"
                    },
                    "handlers": [
                        {
                            "file": "./secret.txt",
                            "file_perm": 384,
                            "notify": [
                                {
                                    "args": [
                                        "./some-other-file"
                                    ],
                                    "command": "touch",
                                    "type": "exec"
                                }
                            ],
                            "type": "file"
                        }
                    ]
                }
            ]
        },
        "tls": {
            "automation": {
                "policies": [
                    {
                        "issuers": [
                            {
                                "module": "internal"
                            }
                        ]
                    }
                ]
            }
        }
    }
}