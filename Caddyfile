{
	order oauth2_session before handle
	debug
	cert_issuer internal
	servers {
		metrics
	}
	secrets {
		store az-kv-srv-01 azure_keyvault https://kv-srv-01.vault.azure.net
		automate {
			source some-secret@az-kv-srv-01
			interval 1h
			template "The value is: {some-secret@az-kv-srv-01}"
			handle file {
				path ./secret.txt
				chmod 0600
				notify exec {
					command touch ./some-other-file
				}
			}
		}
	}
	nats {
		server {
			debug
			name srv-01
			port 4222
			tls local.quara-dev.com
			http_port 8222
			system_account SYS
			accounts {
				OAUTH2 {
					jetstream
				}
				APP {
					map_subject "canary.req.>" {
						to "req.>" weight 50
						to "beta.req.>" weight 50
					}
					map_subject "pub.>" to "pub.srv-01.>"
				}
				SYS {
					export_service "$SYS.REQ.SERVER.PING" to MONITORING
				}
				MONITORING {
					import_service "$SYS.REQ.SERVER.PING" from SYS
				}
			}
			jetstream {
				max_disk 10GB
				max_memory 1GB
			}
			websocket {
				port 10443
				advertise nats.local.quara-dev.com:10443
				tls nats.local.quara-dev.com
			}
			metrics {
				connz
				connz_detailed
			}
		}
		auth_service {
			client in_process {
				name auth-service
			}
			default deny
			policy {
				match {
					type in_process
					client_name oauth2-az-endpoint
				}
				callout allow {
					account OAUTH2
				}
			}
			policy {
				match {
					type websocket
					username APP
				}
				callout oauth2 {
					endpoint az
					account APP
					template {
						allow_pub "{oidc.session.email}.>"
						allow_pub "test.>"
						allow_resp
					}
				}
			}
			policy {
				match {
					token SYS
					host 127.0.0.1
				}
				callout allow {
					account SYS
				}
			}
			policy {
				match {
					token monitoring
					host 127.0.0.1
				}
				callout allow {
					account MONITORING
				}
			}
		}
	}
	oauth2 {
		endpoint az {
			store jetstream {
				name OAUTH2-SESSIONS
				client in_process {
					name oauth2-az-endpoint
				}
			}
			display_debug
			cookie_secure
			cookie_name _oauth2_session
			cookie_http_only no
			cookie_domains .local.quara-dev.com
			email_domains *
			whitelist_domains .local.quara-dev.com
			extra_jwt_issuers https://sts.windows.net/96bdcf75-3f33-4995-966b-d8eddb861f9b/=4a224c79-38e2-487f-96e0-5f4febfa4ce1
			provider oidc {
				id azure-ad
				name "Azure AD"
				client_id "4a224c79-38e2-487f-96e0-5f4febfa4ce1"
				client_secret "{secret.oauth2-client-secret@az-kv-srv-01}"
				scope openid email profile
				login_url https://login.microsoftonline.com/96bdcf75-3f33-4995-966b-d8eddb861f9b/v2.0/oauth2/authorize
				redeem_url https://login.microsoftonline.com/96bdcf75-3f33-4995-966b-d8eddb861f9b/v2.0/oauth2/token
				profile_url https://graph.microsoft.com/v1.0/me
				oidc_issuer_url https://login.microsoftonline.com/96bdcf75-3f33-4995-966b-d8eddb861f9b/v2.0
				oidc_jwks_url https://login.microsoftonline.com/common/discovery/keys
				oidc_audience_claims aud
				oidc_email_claim email
				oidc_user_id_claim email
			}
		}
	}
	otelcol {
		service {
			extensions health_check pprof zpages
			pipelines {
				traces {
					receivers otlp
					processors batch
					exporters debug
				}
				metrics {
					receivers otlp
					processors batch
					exporters debug
				}
				logs {
					receivers otlp
					processors batch
					exporters debug
				}
			}
			telemetry {
				logs {
					level debug
					initial_fields {
						service server-01
					}
				}
				metrics {
					level detailed
					address 127.0.0.1:8888
				}
			}
		}
		receivers {
			otlp {
				protocols {
					grpc {
						endpoint 127.0.0.1:4318
					}
					http {
						endpoint 127.0.0.1:4317
					}
				}
			}
		}
		processors {
			batch
		}
		exporters {
			debug
		}
		extensions {
			health_check {
				endpoint 127.0.0.1:4315
			}
			pprof
			zpages
		}
	}
}

local.quara-dev.com {
	log
	oauth2_session {
		endpoint az
	}
	respond "hello world"
}

metrics.local.quara-dev.com {
	log
	oauth2_session {
		endpoint az
	}
	metrics
}
