{
	# This line is required to tell our Web Server that authentication should happen BEFORE forwarding requests to handler
	order authorize_with before handle
	# This line is required to use a local certificate issuer rather than Let's Encrypt or ZeroSSL
	cert_issuer internal
	# This line is required to enable metrics our Web Server
	servers {
		metrics
	}
	# This block is required to have access to secrets stored in Azure Key Vault and to be able to use them in our configuration
	secrets {
		store az-kv-srv-01 azure_keyvault https://kv-srv-01.vault.azure.net
		automate {
			source some-secret@az-kv-srv-01
			interval 1h
			template "The value is: {some-secret@az-kv-srv-01}"
			handle file {
				path ./secret.txt
				chmod 0600
				notify exec {
					command touch ./some-other-file
				}
			}
		}
	}
	# This block is required to configure and start docker containers and networks when our Web Server starts
	docker {
		network mynetwork {
			driver bridge
			ipam {
				subnet 172.200.200.0/24
				gateway 172.200.200.1
			}
		}
		container test {
			image docker.io/library/alpine:latest
			command sleep 3600
			network mynetwork
			restart always
			mount /data/test to /data
			environment {
				ENV1 "value1"
				ENV2 "value2"
			}
			env ENV3 "value3"
			label com.quara-dev.service "test"
			label com.quara-dev.service.version "1.0.0"
			label com.quara-dev.service.env "dev"
		}
	}
	# This block is required to configure and start NATS server when our Web Server starts
	nats {
		debug
		metrics all
		default_auth_callout deny
		account OAUTH2 {
			jetstream on
			auth_policy {
				match {
					connection_type in_process
					client_name oauth2-az-endpoint
				}
				callout allow
			}
		}
		account APP {
			map_subject "canary.req.>" {
				to "req.>" weight 50
				to "beta.req.>" weight 50
			}
			map_subject "pub.>" to "pub.srv-01.>"
			auth_policy {
				match {
					connection_type nats
					client_host 127.0.0.1
					client_token APP
				}
				callout allow
			}
			auth_policy {
				match {
					connection_type websocket
					client_username APP
				}
				callout oauth2 {
					endpoint az-oidc-endpoint
					template {
						allow_sub "_INBOX.{oidc.session.email}.>"
						allow_sub "{oidc.session.email}.>"
						allow_pub ">"
						allow_resp
					}
				}
			}
		}
		account SYS {
			export_service "$SYS.REQ.SERVER.PING" to MONITORING
			auth_policy {
				match {
					client_token SYS
					client_host 127.0.0.1
				}
				callout allow
			}
		}
		account MONITORING {
			import_service "$SYS.REQ.SERVER.PING" from SYS
			auth_policy {
				match {
					client_token monitoring
					client_host 127.0.0.1
				}
				callout allow
			}
		}
		jetstream {
			unique_tag region
			max_disk 10GB
			max_memory 1GB
		}
		server {
			name srv-01
			tags region:eu-west-3
			host 127.0.0.1
			port 4222
			http_port 8222
			system_account SYS
		}
		websocket_server {
			host 0.0.0.0
			port 10443
			advertise nats.local.quara-dev.com:10443
			tls nats.local.quara-dev.com
		}
		mqtt_server {
			host 0.0.0.0
			port 8883
			tls mqtt.local.quara-dev.com
		}
	}
	# This block is required to configure OAuth2 authentication and authorization endpoints
	# An endpoint is a combination of a store and a provider. A store is used to save sessions and a provider is used to authenticate users.
	oauth2 {
		az-oidc-endpoint {
			store jetstream {
				name OAUTH2-SESSIONS
				client in_process {
					name oauth2-az-endpoint
				}
			}
			display_debug
			cookie_secure
			cookie_name _oauth2_session
			cookie_http_only no
			cookie_domains .local.quara-dev.com
			email_domains *
			whitelist_domains .local.quara-dev.com
			extra_jwt_issuers https://sts.windows.net/96bdcf75-3f33-4995-966b-d8eddb861f9b/=4a224c79-38e2-487f-96e0-5f4febfa4ce1
			provider oidc {
				id azure-ad
				name "Azure AD"
				client_id "4a224c79-38e2-487f-96e0-5f4febfa4ce1"
				client_secret "{secret.oauth2-client-secret@az-kv-srv-01}"
				scope openid email profile
				login_url https://login.microsoftonline.com/96bdcf75-3f33-4995-966b-d8eddb861f9b/v2.0/oauth2/authorize
				redeem_url https://login.microsoftonline.com/96bdcf75-3f33-4995-966b-d8eddb861f9b/v2.0/oauth2/token
				profile_url https://graph.microsoft.com/v1.0/me
				oidc_issuer_url https://login.microsoftonline.com/96bdcf75-3f33-4995-966b-d8eddb861f9b/v2.0
				oidc_jwks_url https://login.microsoftonline.com/common/discovery/keys
				oidc_audience_claims aud
				oidc_email_claim email
				oidc_user_id_claim email
			}
		}
	}
	# This block is required to configure and start OpenTelemetry Collector when our Web Server starts
	otelcol {
		extension basicauth/client {
			username {secret.quara-grafana-stack-id@az-kv-srv-01}
			password {secret.quara-grafana-stack-token@az-kv-srv-01}
		}
		receiver prometheus {
			scrape_interval 10s
			scrape_timeout 1s
			# Scrap caddy and otel-collector metrics
			scrape_config caddy-beyond localhost:2019
			scrape_config otel-collector localhost:2020
			# Scrap additional metrics
			# ...
		}
		receiver otlp {
			grpc 127.0.0.1:4317
			http 127.0.0.1:4318
		}
		exporter otlphttp {
			endpoint https://otlp-gateway-prod-eu-west-3.grafana.net/otlp
			authenticator basicauth/client
		}
		processor batch
		processor attributes {
			action insert {
				key beyond.server
				value srv-01
			}
		}
		service {
			metrics 127.0.0.1:2020
			metrics_level detailed
			extensions basicauth/client
			trace_pipeline {
				receivers otlp
				processors batch attributes
				exporters otlphttp
			}
			metric_pipeline {
				receivers otlp prometheus
				processors batch attributes
				exporters otlphttp
			}
			log_pipeline {
				receivers otlp
				processors batch attributes
				exporters otlphttp
			}
		}
	}
}

# Each website is defined by a block like this one
local.quara-dev.com {
	log
	authorize_with oauth2 az-oidc-endpoint
	respond "hello world"
}

# This is another website
admin.local.quara-dev.com {
	log
	authorize_with oauth2 az-oidc-endpoint
	root * ./www/index.html
	file_server
}

# Yet another website, which serves web server and NATS metrics
metrics.local.quara-dev.com {
	log
	authorize_with oauth2 az-oidc-endpoint
	metrics
}
