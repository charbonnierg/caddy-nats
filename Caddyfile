{
	# This line is required to tell our Web Server that authentication should happen BEFORE forwarding requests to handler
	order oauth2_session before handle
	# This line is required to use a local certificate issuer rather than Let's Encrypt or ZeroSSL
	cert_issuer internal
	# This line is required to enable metrics our Web Server
	servers {
		metrics
	}
	# This block is required to have access to secrets stored in Azure Key Vault and to be able to use them in our configuration
	secrets {
		store az-kv-srv-01 azure_keyvault https://kv-srv-01.vault.azure.net
		automate {
			source some-secret@az-kv-srv-01
			interval 1h
			template "The value is: {some-secret@az-kv-srv-01}"
			handle file {
				path ./secret.txt
				chmod 0600
				notify exec {
					command touch ./some-other-file
				}
			}
		}
	}
	# This block is required to configure and start docker containers and networks when our Web Server starts
	docker {
		network mynetwork {
			driver bridge
			ipam {
				subnet 172.200.200.0/24
				gateway 172.200.200.1
			}
		}
		container test {
			image docker.io/library/alpine:latest
			command sleep 3600
			network mynetwork
			restart always
			mount /data/test to /data
			environment {
				ENV1 "value1"
				ENV2 "value2"
			}
			env ENV3 "value3"
			label com.quara-dev.service "test"
			label com.quara-dev.service.version "1.0.0"
			label com.quara-dev.service.env "dev"
		}
	}
	# This block is required to configure and start NATS server when our Web Server starts
	nats {
		server {
			debug
			name srv-01
			port 4222
			http_port 8222
			system_account SYS
			accounts {
				OAUTH2 {
					jetstream
				}
				APP {
					map_subject "canary.req.>" {
						to "req.>" weight 50
						to "beta.req.>" weight 50
					}
					map_subject "pub.>" to "pub.srv-01.>"
				}
				SYS {
					export_service "$SYS.REQ.SERVER.PING" to MONITORING
				}
				MONITORING {
					import_service "$SYS.REQ.SERVER.PING" from SYS
				}
			}
			jetstream {
				max_disk 10GB
				max_memory 1GB
			}
			websocket {
				port 10443
				advertise nats.local.quara-dev.com:10443
				tls nats.local.quara-dev.com
			}
			metrics {
				connz
				connz_detailed
			}
		}
		auth_service {
			client in_process {
				name auth-service
			}
			default deny
			policy {
				match {
					type in_process
					client_name oauth2-az-endpoint
				}
				callout allow {
					account OAUTH2
				}
			}
			policy {
				match {
					type websocket
					username APP
				}
				callout oauth2 {
					endpoint az
					account APP
					template {
						allow_pub "{oidc.session.email}.>"
						allow_pub "test.>"
						allow_resp
					}
				}
			}
			policy {
				match {
					token SYS
					host 127.0.0.1
				}
				callout allow {
					account SYS
				}
			}
			policy {
				match {
					token monitoring
					host 127.0.0.1
				}
				callout allow {
					account MONITORING
				}
			}
		}
	}
	# This block is required to configure OAuth2 authentication and authorization endpoints
	# An endpoint is a combination of a store and a provider. A store is used to save sessions and a provider is used to authenticate users.
	oauth2 {
		endpoint az {
			store jetstream {
				name OAUTH2-SESSIONS
				client in_process {
					name oauth2-az-endpoint
				}
			}
			display_debug
			cookie_secure
			cookie_name _oauth2_session
			cookie_http_only no
			cookie_domains .local.quara-dev.com
			email_domains *
			whitelist_domains .local.quara-dev.com
			extra_jwt_issuers https://sts.windows.net/96bdcf75-3f33-4995-966b-d8eddb861f9b/=4a224c79-38e2-487f-96e0-5f4febfa4ce1
			provider oidc {
				id azure-ad
				name "Azure AD"
				client_id "4a224c79-38e2-487f-96e0-5f4febfa4ce1"
				client_secret "{secret.oauth2-client-secret@az-kv-srv-01}"
				scope openid email profile
				login_url https://login.microsoftonline.com/96bdcf75-3f33-4995-966b-d8eddb861f9b/v2.0/oauth2/authorize
				redeem_url https://login.microsoftonline.com/96bdcf75-3f33-4995-966b-d8eddb861f9b/v2.0/oauth2/token
				profile_url https://graph.microsoft.com/v1.0/me
				oidc_issuer_url https://login.microsoftonline.com/96bdcf75-3f33-4995-966b-d8eddb861f9b/v2.0
				oidc_jwks_url https://login.microsoftonline.com/common/discovery/keys
				oidc_audience_claims aud
				oidc_email_claim email
				oidc_user_id_claim email
			}
		}
	}
	# This block is required to configure and start OpenTelemetry Collector when our Web Server starts
	otelcol {
		extension basicauth/client {
			username {secret.quara-grafana-stack-id@az-kv-srv-01}
			password {secret.quara-grafana-stack-token@az-kv-srv-01}
		}
		receiver prometheus {
			scrape_interval 10s
			scrape_timeout 1s
			# Scrap caddy and otel-collector metrics
			scrape_config caddy-beyond localhost:2019
			scrape_config otel-collector localhost:2020
			# Scrap additional metrics
			# ...
		}
		receiver otlp {
			grpc 127.0.0.1:4317
			http 127.0.0.1:4318
		}
		exporter otlphttp {
			endpoint https://otlp-gateway-prod-eu-west-3.grafana.net/otlp
			authenticator basicauth/client
		}
		processor batch
		processor attributes {
			action insert {
				key beyond.server
				value srv-01
			}
		}
		service {
			metrics 127.0.0.1:2020
			metrics_level detailed
			extensions basicauth/client
			trace_pipeline {
				receivers otlp
				processors batch attributes
				exporters otlphttp
			}
			metric_pipeline {
				receivers otlp prometheus
				processors batch attributes
				exporters otlphttp
			}
			log_pipeline {
				receivers otlp
				processors batch attributes
				exporters otlphttp
			}
		}
	}
}

# Each website is defined by a block like this one
local.quara-dev.com {
	log
	oauth2_session {
		endpoint az
	}
	respond "hello world"
}

# This is another website
admin.local.quara-dev.com {
	log
	oauth2_session {
		endpoint az
	}
	root * ./www/index.html
	file_server
}

# Yet another website, which serves web server and NATS metrics
metrics.local.quara-dev.com {
	log
	oauth2_session {
		endpoint az
	}
	metrics
}
